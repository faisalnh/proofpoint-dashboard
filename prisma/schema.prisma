// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum AppRole {
  admin
  staff
  manager
  director
  supervisor
}

enum UserStatus {
  active
  suspended
  deleted
}

enum AssessmentStatus {
  draft
  self_submitted
  manager_reviewed
  director_approved
  admin_reviewed
  acknowledged
  rejected
  returned
}

enum QuestionStatus {
  pending
  answered
  closed
}

enum WorkflowStepType {
  review
  approval
  review_and_approval
  acknowledge
}

// Models
model Department {
  id          String   @id @default(uuid())
  name        String   @db.Text
  parentId    String?  @map("parent_id")
  parent      Department? @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Department[] @relation("DepartmentHierarchy")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @map("updated_at")

  profiles            Profile[]
  rubricTemplates     RubricTemplate[]
  departmentRoles     DepartmentRole[]

  @@index([parentId])
  @@map("departments")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique @db.Text
  passwordHash String     @map("password_hash") @db.Text
  emailVerified Boolean  @default(false) @map("email_verified")
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @default(now()) @map("updated_at")

  profile           Profile?
  roles             UserRole[]
  createdTemplates  RubricTemplate[] @relation("TemplateCreator")
  assessments       Assessment[]    @relation("StaffAssessments")
  managerAssessments Assessment[]    @relation("ManagerAssessments")
  directorAssessments Assessment[]   @relation("DirectorAssessments")
  returnedAssessments Assessment[]   @relation("ReturnedAssessments")
  askedQuestions     AssessmentQuestion[] @relation("AskedQuestions")
  answeredQuestions  AssessmentQuestion[] @relation("AnsweredQuestions")
  notificationPreferences NotificationPreference?
  notifications Notification[]

  @@index([status])
  @@map("users")
}

model Profile {
  id           String    @id @default(uuid())
  userId       String    @unique @map("user_id")
  email        String    @db.Text
  fullName     String?   @map("full_name") @db.Text
  niy          String?   @db.Text
  jobTitle     String?   @map("job_title") @db.Text
  departmentId String?   @map("department_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @map("updated_at")

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department  Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([departmentId])
  @@map("profiles")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      AppRole  @default(staff)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([userId])
  @@map("user_roles")
}

model RubricTemplate {
  id           String    @id @default(uuid())
  name         String    @db.Text
  description  String?   @db.Text
  departmentId String?   @map("department_id")
  isGlobal     Boolean   @default(false) @map("is_global")
  createdById  String?   @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @map("updated_at")

  department       Department?       @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  createdBy        User?             @relation("TemplateCreator", fields: [createdById], references: [id], onDelete: SetNull)
  sections         RubricSection[]
  domains          KpiDomain[]
  departmentRoles  DepartmentRole[]
  assessments      Assessment[]

  @@map("rubric_templates")
}

model RubricSection {
  id         String   @id @default(uuid())
  templateId String   @map("template_id")
  name       String   @db.Text
  weight     Decimal? @db.Decimal(5, 2)
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  template   RubricTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  indicators RubricIndicator[]

  @@map("rubric_sections")
}

model RubricIndicator {
  id               String   @id @default(uuid())
  sectionId        String   @map("section_id")
  name             String   @db.Text
  description      String?  @db.Text
  sortOrder        Int      @default(0) @map("sort_order")
  evidenceGuidance String?  @map("evidence_guidance") @db.Text
  scoreOptions     Json?    @map("score_options")
  createdAt        DateTime @default(now()) @map("created_at")

  section RubricSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  questions AssessmentQuestion[]

  @@map("rubric_indicators")
}

model KpiDomain {
  id         String   @id @default(uuid())
  templateId String   @map("template_id")
  name       String   @db.Text
  weight     Decimal  @default(0) @db.Decimal(5, 2)
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  template  RubricTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  standards KpiStandard[]

  @@index([templateId])
  @@map("kpi_domains")
}

model KpiStandard {
  id         String   @id @default(uuid())
  domainId   String   @map("domain_id")
  name       String   @db.Text
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  domain KpiDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)
  kpis   Kpi[]

  @@index([domainId])
  @@map("kpi_standards")
}

model Kpi {
  id                String   @id @default(uuid())
  standardId        String   @map("standard_id")
  name              String   @db.Text
  description       String?  @db.Text
  evidenceGuidance  String?  @map("evidence_guidance") @db.Text
  trainings         String?  @db.Text
  sortOrder         Int      @default(0) @map("sort_order")
  rubric4           String   @map("rubric_4") @db.Text
  rubric3           String   @map("rubric_3") @db.Text
  rubric2           String   @map("rubric_2") @db.Text
  rubric1           String   @map("rubric_1") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")

  standard KpiStandard @relation(fields: [standardId], references: [id], onDelete: Cascade)

  @@index([standardId])
  @@map("kpis")
}

model Assessment {
  id                  String            @id @default(uuid())
  staffId             String            @map("staff_id")
  managerId           String?           @map("manager_id")
  directorId          String?           @map("director_id")
  templateId          String?           @map("template_id")
  period              String            @db.Text
  status              AssessmentStatus
  staffScores         Json              @default("{}") @map("staff_scores")
  managerScores       Json              @default("{}") @map("manager_scores")
  staffEvidence       Json              @default("{}") @map("staff_evidence")
  managerEvidence     Json              @default("{}") @map("manager_evidence")
  managerNotes        String?           @map("manager_notes") @db.Text
  directorComments    String?           @map("director_comments") @db.Text
  returnFeedback      String?           @map("return_feedback") @db.Text
  returnedAt          DateTime?         @map("returned_at")
  returnedById        String?           @map("returned_by")
  finalScore          Decimal?          @map("final_score") @db.Decimal(4, 2)
  finalGrade          String?           @map("final_grade") @db.Text
  staffSubmittedAt    DateTime?         @map("staff_submitted_at")
  managerReviewedAt   DateTime?         @map("manager_reviewed_at")
  directorApprovedAt  DateTime?         @map("director_approved_at")
  staffNotes          String?           @map("staff_notes") @db.Text
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @default(now()) @map("updated_at")

  staff        User  @relation("StaffAssessments", fields: [staffId], references: [id], onDelete: Cascade)
  manager      User? @relation("ManagerAssessments", fields: [managerId], references: [id], onDelete: SetNull)
  director     User? @relation("DirectorAssessments", fields: [directorId], references: [id], onDelete: SetNull)
  template     RubricTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  returnedBy   User? @relation("ReturnedAssessments", fields: [returnedById], references: [id], onDelete: SetNull)
  questions    AssessmentQuestion[]
  notifications Notification[]

  @@index([staffId])
  @@index([managerId])
  @@index([directorId])
  @@index([status])
  @@index([returnedById])
  @@map("assessments")
}

model AssessmentQuestion {
  id            String         @id @default(uuid())
  assessmentId  String         @map("assessment_id")
  indicatorId   String?        @map("indicator_id")
  askedBy       String         @map("asked_by")
  question      String         @db.Text
  response      String?        @db.Text
  respondedById String?        @map("responded_by")
  respondedAt   DateTime?      @map("responded_at")
  status        QuestionStatus
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @default(now()) @map("updated_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  indicator  RubricIndicator? @relation(fields: [indicatorId], references: [id], onDelete: SetNull)
  askedByUser User @relation("AskedQuestions", fields: [askedBy], references: [id])
  respondedByUser User? @relation("AnsweredQuestions", fields: [respondedById], references: [id])

  @@index([assessmentId])
  @@map("assessment_questions")
}

model DepartmentRole {
  id                String         @id @default(uuid())
  departmentId      String?        @map("department_id")
  role              AppRole
  defaultTemplateId String?        @map("default_template_id")
  name              String?        @db.Text
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @default(now()) @map("updated_at")

  department       Department?  @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  defaultTemplate  RubricTemplate? @relation(fields: [defaultTemplateId], references: [id], onDelete: SetNull)
  approvalWorkflows ApprovalWorkflow[]

  @@unique([departmentId, role])
  @@index([departmentId])
  @@index([role])
  @@map("department_roles")
}

model ApprovalWorkflow {
  id               String          @id @default(uuid())
  departmentRoleId String          @map("department_role_id")
  stepOrder        Int             @map("step_order")
  approverRole     AppRole         @map("approver_role")
  stepType         WorkflowStepType @map("step_type")
  createdAt        DateTime        @default(now()) @map("created_at")

  departmentRole DepartmentRole @relation(fields: [departmentRoleId], references: [id], onDelete: Cascade)

  @@index([departmentRoleId])
  @@map("approval_workflows")
}

model Notification {
  id           Int                @id @default(autoincrement())
  assessmentId String?            @map("assessment_id")
  userId       String?            @map("user_id")
  type         NotificationType
  status       NotificationStatus @default(pending)
  error        String?            @db.Text
  sentAt       DateTime?          @map("sent_at")
  createdAt    DateTime           @default(now()) @map("created_at")

  assessment Assessment? @relation(fields: [assessmentId], references: [id], onDelete: SetNull)
  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([assessmentId])
  @@index([status])
  @@index([userId])
  @@map("notifications")
}

model NotificationPreference {
  id                     Int      @id @default(autoincrement())
  userId                 String   @unique @map("user_id")
  emailEnabled           Boolean  @default(true) @map("email_enabled")
  assessmentSubmitted    Boolean  @default(true) @map("assessment_submitted")
  managerReviewDone      Boolean  @default(true) @map("manager_review_done")
  directorApproved       Boolean  @default(true) @map("director_approved")
  adminReleased          Boolean  @default(true) @map("admin_released")
  assessmentReturned     Boolean  @default(true) @map("assessment_returned")
  assessmentAcknowledged Boolean  @default(true) @map("assessment_acknowledged")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @default(now()) @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum NotificationType {
  assessment_submitted
  manager_review_completed
  director_approved
  admin_released
  assessment_returned
  assessment_acknowledged
}
